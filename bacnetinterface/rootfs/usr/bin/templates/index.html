<!DOCTYPE html>
<html>
<head>
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
    <style>
        body {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 400;
        }

        * {
            box-sizing: border-box;
            padding: 0;
            margin: 0;
        }


        .parent {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: 0.8fr 0.2fr repeat(3, 1fr);
            grid-column-gap: 0px;
            grid-row-gap: 0px;
            border: 2px solid #f60000;
            width: 100vw;
            height: 100vh;
            background-color: white;
            text-align: center;
        }

        .div1 {
            grid-area: 1 / 1 / 2 / 6;
            border: 2px solid #f60000;
            text-align: center;
        }

        .div2 {
            border: 2px solid #f60000;
            grid-area: 2 / 1 / 3 / 6;
            background-color: #f60000;
        }

            .div2 a {
                float: left;
                display: block;
                color: white;
                margin-top: 0;
                padding-left: 10px;
                padding-right: 10px;
                height: 100%;
                line-height: 300%;
            }

                .div2 a:hover {
                    background-color: white;
                    color: #f60000;
                }

        .div3 {
            border: 2px solid #f60000;
            grid-area: 3 / 1 / 6 / 2;
        }

        .div4 {
            border: 2px solid #f60000;
            grid-area: 3 / 2 / 6 / 5;
            align-items: center; /* Centering the table vertically */
            overflow-y: scroll;
            scrollbar-width: none; /* Firefox */
        }

        .div5 {
            border: 2px solid #f60000;
            grid-area: 3 / 5 / 6 / 6;
        }

        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }

        th, td {
            padding: 5px;
        }

        th {
            text-align: left;
        }

        .button {
            padding: 10px;
            width: 100%;
            border: none;
            background-color: #f60000;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

            .button:hover {
                background-color: white;
                color: #f60000
            }
    </style>
    <title>WebUI</title>
</head>
<body>
    <div class="parent">
        <div class="div1">
            <img src="https://www.bepacom.nl/wp-content/uploads/2018/09/logo-bepacom-besturingstechniek.jpg" alt="Bepacom B.V. Raalte" style="float: left; justify-content: center; align-items: center; height:40px;">
            <h1>BACnet/IP Interface</h1>
        </div>
        <div class="div2">
            <a href=".">Refresh</a>
        </div>
        <div class="div3">
            <button class="button" onclick="command('iam')">I Am Request</button>
            <button class="button" onclick="command('whois')">Who Is Request</button>
            <button class="button" onclick="command('readall')">Read All Devices</button>
        </div>
        <div class="div4">
            <table id="table" style="width:100%">
                <!--Gets generated by Javascript-->
            </table>
        </div>
        <div class="div5">

        </div>
    </div>
    <script>
        const API_URL = './apiv1/json';

        let hostname = location.hostname

        var refreshing = false; // flag to check if the page is already

        function command(text) {

            if (refreshing) return; // if the page is already refreshing, return and don't call the function again

            let url = "../apiv1/command/" + text

            fetch(url)
                .then(response => response.text())
                .then(data => {
                    console.log(data);
                    // do something with the data here
                });
        }


        document.addEventListener("DOMContentLoaded", function () {
            const table = document.getElementById("table");

            function updateTable() {
                fetch("../apiv1/json")
                    .then(response => response.json())
                    .then(data => {
                        // Clear the table
                        while (table.firstChild) {
                            table.removeChild(table.firstChild);
                        }
                        let devicelist = [];
                        let objectlist = [];
                        for (let device in data) {
                            for (let object in data[device]) {
                                for (let key in data[device][object]) {
                                    let value = data[device][object][key];
                                    let row = document.createElement("tr");
                                    let deviceCol = document.createElement("td");
                                    let objectCol = document.createElement("td");
                                    let keyCol = document.createElement("td");
                                    let valueCol = document.createElement("td");

                                    if (devicelist.includes(device)) {
                                        deviceCol.innerHTML = "";
                                    } else {
                                        deviceCol.innerHTML = device;
                                        devicelist.push(device);
                                    }

                                    if (objectlist.includes(object)) {
                                        objectCol.innerHTML = "";
                                    } else {
                                        objectCol.innerHTML = object;
                                        objectlist.push(object);
                                    }

                                    keyCol.innerHTML = key;
                                    valueCol.innerHTML = value;

                                    row.appendChild(deviceCol);
                                    row.appendChild(objectCol);
                                    row.appendChild(keyCol);
                                    row.appendChild(valueCol);
                                    table.appendChild(row);
                                }
                            }
                        }
                    });
            }
            //call the updateTable function every 2 seconds
            setInterval(updateTable, 1000);
        });



    </script>
</body>
</html>