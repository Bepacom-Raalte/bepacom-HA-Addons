<!DOCTYPE html>
<html>
<head>
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
    <link href="{{ url_for('static', path='/css/styles.css') }}" rel="stylesheet">
    <title>WebUI</title>
</head>
<body>
    <div class="parent">
        <div class="div1">
            <img src="https://www.bepacom.nl/wp-content/uploads/2018/09/logo-bepacom-besturingstechniek.jpg" alt="Bepacom B.V. Raalte" style="margin:1%; justify-content: center; align-items: center; height:40px;">
            <h1>BACnet/IP Interface</h1>
        </div>
        <div class="div2">
            <a href="./webapp" title="Main page where you can see all devices, objects and values.">Main</a>
            <a href="./subscriptions" title="Page where you can see all subscriptions.">Subscriptions</a>
            <a href="./ede" title="Page where you can see manage EDE files.">EDE</a>
            <a href="./docs" title="API documentation can be found here. Need an internet connection to load the page.">Swagger API Docs</a>
            <a href="./redoc" title="API documentation can be found here. Need an internet connection to load the page.">Redoc API Docs</a>
            <a href="https://www.bepacom.nl" style="float:right;" title="Bepacom, the company that made this possible.">About</a>
        </div>
        <div class="div3">
            <button class="button" onclick="command('iam')" title="Send I Am Request over the BACnet network.">I Am Request</button>
            <button class="button" onclick="command('whois')" title="Send Who Is Request over the BACnet network.">Who Is Request</button>
            <button class="button" onclick="command('readall')" title="Send Read Request to all devices over the BACnet network.">Read All Devices</button>
        </div>
        <div class="div4">
            <label style="background-color: #f60000; color: white;">Device Browser</label>
            <ul id="collapsible">
                <!--Gets generated by Javascript-->
                {% for device in bacnet_devices %}
                <li id={{ device }} class="device-tree">
                    <input type="checkbox" id="checkbox-{{ device }}" onclick="cool(event)">
                    <label for="checkbox-{{device}}" class="device_select">{{ device }}</label>
                    <ul>
                        {% for object in bacnet_devices[device] %}
                        <li id="{{ device }}-{{object}}" class="object-tree">
                            <input type="checkbox" id="checkbox-{{ device }}-{{object}}" onclick="cool(event)">
                            <label for="checkbox-{{device}}-{{object}}" class="object_select">{{ object }}</label>

                            <ul>
                                {% for property in bacnet_devices[device][object] %}
                                <li class="properties">
                                    <label id="{{device}}-{{object}}-{{property}}" class="property">{{ property }} : {{ bacnet_devices[device][object][property] }}</label>
                                </li>
                                {% endfor %}
                            </ul>
                        </li>
                        {% endfor %}
                    </ul>
                </li>
                {% endfor %}
            </ul>
        </div>
        <div class="div5">
            <form id="form">
                <label for="device">Select Device:</label>
                <select id="device" name="device" title="Device you want to write to."></select>
                <br>
                <label for="object">Select Object:</label>
                <select id="object" name="object" title="Object you want to write to."></select>
                <br>
                <label for="property">Property identifier:</label>
                <input type="text" id="property" name="property" title="Property to write to. Write in camelCase, i.e. presentValue or outOfService.">
                <br>
                <label for="value">Value:</label>
                <input type="text" id="value" name="value" title="Value to write to property.">
                <br>
                <label for="priority">Priority:</label>
                <input type="text" id="priority" name="priority" title="Priority to write with.">
                <br>
                <input type="button" value="Write" onclick="submitForm()" title="Send Write Request.">
            </form>
        </div>
    </div>
    <!-- Groeten van de afstudeerder -->
    <script>
        updateCheckboxes()
        const API_URL = './apiv1/json';
        var refreshing = false; // flag to check if the page is already
        var devicedict = null;

        fetch(API_URL)
            .then((response) => response.json())
            .then((data) => {
                devicedict = data;
                updateProperties(devicedict)
                fillOptions()
            });

        function command(text) {
            if (refreshing) return; // if the page is already refreshing, return and don't call the function again
            let url = "./apiv1/command/" + text
            fetch(url).then(response => response.text()).then(data => {
                console.log(data);
                // do something with the data here
            });
            switch (text) {
                case "whois":
                    alert('Who Is Request Sent!');
                    break
                case "iam":
                    alert('I Am Request Sent!');
                    break
                case "readall":
                    alert('Multiple Read Request Sent to all detected devices!');
                    break
                default:
                    alert("Something went wrong...")
            }
        }

        let url = window.location.href;
        url = url.replace("http", "ws")
        url = url.replace("webapp", "ws")
        var ws = new WebSocket(url);

        var gotMessage = false;

        ws.onmessage = function (event) {
            event.JSON
            devicedict = JSON.parse(event.data)
            updateProperties(devicedict)
            fillOptions()
        }

        function updateProperties(devicedict) {
            for (let device in devicedict) {
                for (let object in devicedict[device]) {
                    for (let property in devicedict[device][object]) {
                        propertyItem = document.getElementById(device + "-" + object + "-" + property);
                        propertyItem.textContent = property + " : " + devicedict[device][object][property]
                    }
                }
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            updateCheckboxes();
        });
        let devices = [];
        let objects = [];

        function updateList() {
            const list = document.getElementById("collapsible");

            for (let device in devicedict) {
                const deviceItem = document.createElement("li");
                deviceItem.setAttribute("id", device);
                deviceItem.setAttribute("class", "device-tree");

                const deviceInput = document.createElement("input");
                deviceInput.type = "checkbox";
                deviceInput.setAttribute("id", "checkbox-" + device);
                deviceItem.appendChild(deviceInput);

                const deviceLabel = document.createElement("label");
                deviceLabel.setAttribute("for", "checkbox-" + device);
                deviceLabel.textContent = device;
                deviceItem.appendChild(deviceLabel);

                const objectList = document.createElement("ul");
                for (let object in devicedict[device]) {
                    const objectItem = document.createElement("li");
                    objectItem.setAttribute("id", object);
                    objectItem.setAttribute("class", "object-tree");

                    const objectInput = document.createElement("input");
                    objectInput.type = "checkbox";
                    objectInput.setAttribute("id", "checkbox-" + device + "-" + object);
                    objectItem.appendChild(objectInput);

                    const objectLabel = document.createElement("label");
                    objectLabel.setAttribute("for", "checkbox-" + device + "-" + object);
                    objectLabel.textContent = object;
                    objectItem.appendChild(objectLabel);

                    const propertyList = document.createElement("ul");
                    for (let property in devicedict[device][object]) {
                        const propertyItem = document.createElement("li");
                        propertyItem.textContent =
                            property + " : " + devicedict[device][object][property];
                        propertyItem.setAttribute("id", property);

                        const valueItem = document.createElement("p");
                        valueItem.textContent = devicedict[device][object][property];
                        propertyItem.appendChild(valueItem);

                        propertyList.appendChild(propertyItem);
                        console.log(property);
                    }
                    objectItem.appendChild(propertyList);
                    objectList.appendChild(objectItem);
                    console.log(object);
                }
                deviceItem.appendChild(objectList);
                list.appendChild(deviceItem);
                console.log(device);
            }

            // Add event listeners to make the list collapsible
            const checkboxes = document.querySelectorAll("input[type='checkbox']");
            checkboxes.forEach((checkbox) => {
                checkbox.addEventListener("change", function () {
                    const listItem = this.parentNode;
                    const childList = listItem.querySelector("ul");
                    if (childList) {
                        childList.style.display = this.checked ? "block" : "none";
                    }
                });
            });
        }

        function cool(event) {

            var checkbox = document.getElementById(event.target.id);
            //console.log(checkbox.children)
            var dev = event.target.id.replace("checkbox-", "");
            var nestedLi = document.querySelectorAll('li[id*="' + dev + "-" + '"]');

            var something = document.getElementById(dev);
            var children = [...something.children[2].children];


            for (var i = 0; i < children.length; i++) {
                //console.log(children[i])
                if (children[i].id === dev) {
                    // Skip the checkbox element
                    return; // Continue to the next iteration
                }

                if (checkbox.checked) {
                    children[i].style.display = 'block';  // show the nested lists
                } else {
                    children[i].style.display = 'none';   // hide the nested lists
                }
            }
        }

        function cool2(device, object) {

            let id;

            if (object == undefined) {
                id = device
            } else {
                id = device + "-" + object
            }

            var checkbox = document.getElementById("checkbox-" + id);
            var nestedLi = document.querySelectorAll('li[id*="' + id + "-" + '"]');

            console.log(nestedLi);

            nestedLi.forEach(function (li) {
                if (li.id === id) {
                    // Skip the checkbox element
                    return; // Continue to the next iteration
                }

                if (checkbox.checked) {
                    li.style.display = 'block';  // show the nested lists
                } else {
                    li.style.display = 'none';   // hide the nested lists
                }
            });
        }

        function updateCheckboxes() {
            for (let device in devicedict) {
                cool2(device)
            }
        }

        function fillOptions() {
            let selectDevice = document.getElementById("device");
            let selectObject = document.getElementById("object");
            for (let device in devicedict) {
                if (!devices.includes(device)) {
                    devices.push(device);
                    let option = document.createElement("option");
                    option.value = device;
                    option.text = device;
                    selectDevice.appendChild(option);
                }
                for (let object in devicedict[device]) {
                    if (!objects.includes(object)) {
                        objects.push(object);
                        let option = document.createElement("option");
                        option.value = object;
                        option.text = object;
                        selectObject.appendChild(option);
                    }
                }
            }
            console.log(selectDevice)
            console.log(selectObject)
        }

        function submitForm() {
            let device = document.getElementById("device").value;
            let object = document.getElementById("object").value;
            let property = document.getElementById("property").value;
            let value = document.getElementById("value").value;
            let priority = document.getElementById("priority").value;
            let url = `./apiv2/${device}/${object}/${property}?`;

            if (value) {
                url += `value=${value}`;
            }

            if (priority) {
                if (value) {
                    url += `&priority=${priority}`;
                } else {
                    url += `priority=${priority}`;
                }
            }

            let data = {
                property: value
            };
            fetch(url, {
                method: "POST",
                body: JSON.stringify(data),
                headers: {
                    "Content-Type": "application/json"
                }
            }).then((response) => {
                if (response.status == 200) {
                    alert("Write request is being processed!")

                } else {
                    alert("Error during parsing of the write inputs!")
                }
            });
        }
    </script>
</body>
</html>