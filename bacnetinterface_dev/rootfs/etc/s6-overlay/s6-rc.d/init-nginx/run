#!/command/with-contenv bashio
# shellcheck shell=bash

# ==============================================================================
# Initialize the NGINX service
# s6-overlay docs: https://github.com/just-containers/s6-overlay
# ==============================================================================

bashio::log.info "Running init-nginx."

readarray -t eth_adapters < <(ifconfig -a | grep -oE '^(enp|eth|eno|wl)[a-z0-9]+')

bashio::log.debug "Read the array... now going into the for loop."

for adapter in "${eth_adapters[@]}"
do
    ipaddr=$(ifconfig "$adapter" | grep 'inet addr' | cut -d: -f2 | awk '{print $1}')
    if [ -n "$ipaddr" ]; then
        break
    fi
done

bashio::log.debug "Found an IP... $ipaddr."

# Generate Ingress configuration
bashio::var.json \
    interface "$ipaddr" \
    | tempio \
        -template /etc/nginx/templates/ingress.gtpl \
        -out /etc/nginx/servers/ingress.conf

bashio::log.debug "Generated ingress configuration!"
